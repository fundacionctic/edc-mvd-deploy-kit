services:
  #############################################
  # PostgreSQL Database (Internal)
  #############################################
  issuer-postgres:
    image: postgres:16
    container_name: mvd-issuer-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - ./deployment/issuer/init-issuer-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - issuer-db-data:/var/lib/postgresql/data
    networks:
      - mvd-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  #############################################
  # HashiCorp Vault (Internal)
  #############################################
  issuer-vault:
    image: hashicorp/vault:latest
    container_name: mvd-issuer-vault
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${ISSUER_VAULT_TOKEN}
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    networks:
      - mvd-network
    healthcheck:
      test: ["CMD", "vault", "status", "-address=http://127.0.0.1:8200"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  #############################################
  # Issuer Service (Internet-Exposed)
  #############################################
  issuer-service:
    image: issuerservice:latest
    container_name: mvd-issuer-service
    ports:
      - "${ISSUER_HTTP_PORT}:${ISSUER_HTTP_PORT}" # Main API
      - "${ISSUER_STS_PORT}:${ISSUER_STS_PORT}" # STS
      - "${ISSUER_ISSUANCE_PORT}:${ISSUER_ISSUANCE_PORT}" # Issuance
      - "${ISSUER_ADMIN_PORT}:${ISSUER_ADMIN_PORT}" # Admin (SEEDING!)
      - "${ISSUER_VERSION_PORT}:${ISSUER_VERSION_PORT}" # Version
      - "${ISSUER_IDENTITY_PORT}:${ISSUER_IDENTITY_PORT}" # Identity
      - "${ISSUER_DID_API_PORT}:${ISSUER_DID_API_PORT}" # DID
      - "${ISSUER_DEBUG_PORT}:${ISSUER_DEBUG_PORT}" # Debug
    env_file:
      - ./config/issuer-service.env
    depends_on:
      issuer-postgres:
        condition: service_healthy
      issuer-vault:
        condition: service_healthy
    networks:
      - mvd-network
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "http://localhost:${ISSUER_HTTP_PORT}/api/check/health",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

networks:
  mvd-network:
    external: true

volumes:
  issuer-db-data: {}
