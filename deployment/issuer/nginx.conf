# ============================================================
# NGINX CONFIGURATION FOR ISSUER DID DOCUMENT SERVER
# ============================================================
# This NGINX configuration serves the Issuer's DID document
# for DID resolution by other dataspace participants
#
# DID Resolution:
#   did:web:host.docker.internal%3A9876
#   resolves to:
#   http://host.docker.internal:9876/.well-known/did.json
#
# Usage:
#   - DID documents must be served at /.well-known/did.json
#   - NGINX serves static files from /var/www/
#   - The DID document is mounted at /var/www/.well-known/did.json
# ============================================================

events {
  # Maximum number of simultaneous connections per worker process
  worker_connections 1024;
}

http {
  # Default MIME types for served files
  include /etc/nginx/mime.types;
  default_type application/json;

  # Logging configuration
  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;

  server {
    # Listen on port 80 (mapped to ISSUER_DID_PORT on host)
    listen 80;

    # Server name (not critical for Docker internal networking)
    server_name _;

    # Document root directory
    root /var/www/;

    # Default index file (not used, but good practice)
    index index.html;

    # Location block for DID document
    location /.well-known/did.json {
      # Ensure JSON content type
      default_type application/json;

      # CORS headers for cross-origin requests
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Methods "GET, OPTIONS";
      add_header Access-Control-Allow-Headers "Content-Type";

      # Cache control (DID documents are relatively static)
      add_header Cache-Control "public, max-age=3600";
    }

    # Health check endpoint for Docker healthcheck
    location /health {
      access_log off;
      return 200 "OK\n";
      add_header Content-Type text/plain;
    }
  }
}
