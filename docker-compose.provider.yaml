services:
  #############################################
  # PostgreSQL Database (Internal)
  #############################################
  provider-postgres:
    image: postgres:16
    container_name: mvd-provider-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - ./deployment/provider/init-provider-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - provider-db-data:/var/lib/postgresql/data
    networks:
      - mvd-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  #############################################
  # HashiCorp Vault (Internal)
  #############################################
  provider-vault:
    image: hashicorp/vault:latest
    container_name: mvd-provider-vault
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${PROVIDER_VAULT_TOKEN}
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    networks:
      - mvd-network
    healthcheck:
      test: ["CMD", "vault", "status", "-address=http://127.0.0.1:8200"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  #############################################
  # Control Plane (Internet-Exposed)
  #############################################
  provider-controlplane:
    image: controlplane:latest
    container_name: mvd-provider-controlplane
    ports:
      - "${PROVIDER_CP_WEB_PORT}:${PROVIDER_CP_WEB_PORT}" # Health checks
      - "${PROVIDER_CP_MANAGEMENT_PORT}:${PROVIDER_CP_MANAGEMENT_PORT}" # Management API
      - "${PROVIDER_CP_PROTOCOL_PORT}:${PROVIDER_CP_PROTOCOL_PORT}" # DSP Protocol
      - "${PROVIDER_CP_CONTROL_PORT}:${PROVIDER_CP_CONTROL_PORT}" # Data Plane Control
      - "${PROVIDER_CP_CATALOG_PORT}:${PROVIDER_CP_CATALOG_PORT}" # Catalog API
      - "${PROVIDER_CP_DEBUG_PORT}:${PROVIDER_CP_DEBUG_PORT}" # Debug
    env_file:
      - ./config/provider-controlplane.env
    volumes:
      - ./deployment/provider:/app/deployment/provider:ro
      - ./config/trusted-issuers.properties:/app/configuration.properties:ro
    depends_on:
      provider-postgres:
        condition: service_healthy
      provider-vault:
        condition: service_healthy
      provider-identityhub:
        condition: service_healthy
    networks:
      - mvd-network
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "http://localhost:${PROVIDER_CP_WEB_PORT}/api/check/health",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  #############################################
  # Data Plane (Internet-Exposed)
  #############################################
  provider-dataplane:
    image: dataplane:latest
    container_name: mvd-provider-dataplane
    ports:
      - "${PROVIDER_DP_WEB_PORT}:${PROVIDER_DP_WEB_PORT}" # Health checks
      - "${PROVIDER_DP_CONTROL_PORT}:${PROVIDER_DP_CONTROL_PORT}" # Control Plane communication
      - "${PROVIDER_DP_PUBLIC_PORT}:${PROVIDER_DP_PUBLIC_PORT}" # Public data access
      - "${PROVIDER_DP_DEBUG_PORT}:${PROVIDER_DP_DEBUG_PORT}" # Debug
    env_file:
      - ./config/provider-dataplane.env
    depends_on:
      provider-postgres:
        condition: service_healthy
      provider-vault:
        condition: service_healthy
      provider-controlplane:
        condition: service_healthy
    networks:
      - mvd-network
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "http://localhost:${PROVIDER_DP_WEB_PORT}/api/check/health",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  #############################################
  # Identity Hub (Internet-Exposed)
  #############################################
  provider-identityhub:
    image: identity-hub:latest
    container_name: mvd-provider-identityhub
    ports:
      - "${PROVIDER_IH_WEB_PORT}:${PROVIDER_IH_WEB_PORT}" # Health checks
      - "${PROVIDER_IH_CREDENTIALS_PORT}:${PROVIDER_IH_CREDENTIALS_PORT}" # Credentials API
      - "${PROVIDER_IH_STS_PORT}:${PROVIDER_IH_STS_PORT}" # STS Token API
      - "${PROVIDER_IH_DID_PORT}:${PROVIDER_IH_DID_PORT}" # DID API
      - "${PROVIDER_IH_IDENTITY_PORT}:${PROVIDER_IH_IDENTITY_PORT}" # Identity API
      - "${PROVIDER_IH_DEBUG_PORT}:${PROVIDER_IH_DEBUG_PORT}" # Debug
    env_file:
      - ./config/provider-identityhub.env
    depends_on:
      provider-postgres:
        condition: service_healthy
      provider-vault:
        condition: service_healthy
    networks:
      - mvd-network
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "http://localhost:${PROVIDER_IH_WEB_PORT}/api/check/health",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

networks:
  mvd-network:
    external: true

volumes:
  provider-db-data: {}
